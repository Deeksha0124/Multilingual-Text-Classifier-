<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåç Multilingual Text Classifier</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #084298;
      --bg-overlay: rgba(255, 255, 255, 0.85);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 2rem 1rem;
      font-family: 'Poppins', sans-serif;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .main {
      width: 100%;
      max-width: 960px;
      background: var(--bg-overlay);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    h1 {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
      margin-bottom: 1.5rem;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.9rem 1.6rem;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s, transform 0.15s;
    }

    button:hover { background: var(--primary-dark); }
    button:active { transform: scale(0.97); }

    .result-box {
      background: white;
      padding: 1.5rem;
      border-radius: 14px;
      margin-bottom: 2rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }

    .label { font-weight: 600; color: #444; }

    .progress-container {
      width: 100%;
      height: 12px;
      background-color: #e0e0e0;
      border-radius: 6px;
      margin: 10px 0 16px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #0dcaf0, #0d6efd);
      width: 0%;
      transition: width 0.4s ease;
    }

    .stars svg {
      width: 26px;
      height: 26px;
      fill: #ffc107;
    }

    .chart-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
    }

    canvas { max-width: 400px; }

    #datasetAnalysis {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <section class="main">
    <h1>üåç Multilingual Text Classifier</h1>
    <textarea id="reviewInput" placeholder="Enter your review..."></textarea>

    <div class="button-group">
      <button onclick="submitReview()">Analyze</button>
      <button onclick="startVoiceInput()">üé§ Speak</button>
      <button onclick="download('csv')">Download CSV</button>
      <button onclick="download('json')">Download JSON</button>
      <button onclick="showAnalysis()">Show Dataset Analysis</button>
      <button onclick="downloadAnalysis()">Download Analysis Chart</button>
    </div>

    <div class="result-box" id="result" style="display:none;">
      <p><span class="label">Language:</span> <span id="lang"></span></p>
      <p><span class="label">Translated:</span> <span id="translated"></span></p>
      <p><span class="label">Category:</span> <span id="category"></span></p>
      <p><span class="label">Sentiment:</span> <span id="sentiment"></span> <span id="sentimentEmoji" style="font-size:1.3rem;"></span></p>
      <p><span class="label"> </span> <span id="rating"></span></p>
      <div class="stars" id="starRating"></div>
      <p><span class="label">Confidence:</span> <span id="confidence"></span></p>
      <div class="progress-container"><div class="progress-bar" id="confidenceBar"></div></div>
      <p><span class="label">Scores:</span> <span id="scores"></span></p>
    </div>

    <div class="chart-wrapper">
      <canvas id="sentimentChart"></canvas>
      <canvas id="languageChart"></canvas>
    </div>

    <img id="datasetAnalysis" alt="Dataset analysis chart" />
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function submitReview() {
      const review = document.getElementById('reviewInput').value.trim();
      if(!review) return alert('Please enter a review.');
      const res = await fetch('/predict', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ review })
      });
      const data = await res.json();
      if(data.error) return alert(data.error);

      document.getElementById('lang').textContent = data.detected_language;
      document.getElementById('translated').textContent = data.translated_text;
      document.getElementById('category').textContent = data.product_category;
      document.getElementById('sentiment').textContent = data.predicted_sentiment;
      document.getElementById('sentimentEmoji').textContent = data.emoji;

      const ratingRaw = data.suggested_star_rating;
      const rating = parseFloat(ratingRaw);
      if (!isNaN(rating)) {
        document.getElementById('rating').textContent = rating.toFixed(1);
        renderStars(rating);
      } else {
        document.getElementById('rating').textContent = " ";
        document.getElementById('starRating').innerHTML = "";
      }

      const conf = parseFloat(data.sentiment_scores[data.predicted_sentiment].replace('%',''));
      document.getElementById('confidence').textContent = conf.toFixed(2)+'%';
      document.getElementById('confidenceBar').style.width = conf+'%';

      document.getElementById('scores').textContent = JSON.stringify(data.sentiment_scores, null, 2);
      document.getElementById('result').style.display='block';

      await loadCharts();
    }

    function renderStars(rating){
      const full=Math.floor(rating); const half=rating%1>=0.5; const total=5;
      const starFull='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.3l6.2 3.8-1.6-7 5.4-4.7-7.1-.6L12 2 9.1 8.8l-7.1.6 5.4 4.7-1.6 7z"/></svg>';
      const starHalf='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.3V2l2.9 6.8 7.1.6-5.4 4.7 1.6 7z" fill="#ffc107"/><path d="M12 17.3L5.8 21.1l1.6-7-5.4-4.7 7.1-.6z" fill="#e0e0e0"/></svg>';
      const starEmpty='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#e0e0e0" d="M12 17.3l6.2 3.8-1.6-7 5.4-4.7-7.1-.6L12 2 9.1 8.8l-7.1.6 5.4 4.7-1.6 7z"/></svg>';
      let html='';
      for(let i=0;i<full;i++) html+=starFull;
      if(half) html+=starHalf;
      for(let i=full+half;i<total;i++) html+=starEmpty;
      document.getElementById('starRating').innerHTML=html;
    }

    function download(format){ window.location.href='/export?format='+format; }

    async function loadCharts(){
      const res=await fetch('/stats'); const stats=await res.json();
      renderChart('sentimentChart','Sentiment Distribution',stats.sentiment_counts||{});
      renderChart('languageChart','Language Distribution',stats.language_counts||{});
    }

    function renderChart(id,label,data){
      const ctx=document.getElementById(id).getContext('2d');
      if(window[id]) window[id].destroy();
      window[id]=new Chart(ctx,{type:'bar',data:{labels:Object.keys(data),datasets:[{label,data:Object.values(data),backgroundColor:Object.keys(data).map((_,i)=>['#4CAF50','#FFC107','#F44336','#2196F3','#9C27B0','#00BCD4'][i%6])}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }

    function showAnalysis(){
      const img=document.getElementById('datasetAnalysis');
      img.src='/analysis_image?ts='+Date.now();
      img.style.display='block';
      img.scrollIntoView({behavior:'smooth'});
    }

    function downloadAnalysis(){
      const link=document.createElement('a');
      link.href='/analysis_image';
      link.download='dataset_analysis.png';
      link.click();
    }

    function startVoiceInput() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('reviewInput').value = transcript;
        submitReview();
      };

      recognition.onerror = (event) => {
        alert('Speech recognition error: ' + event.error);
      };
    }

    window.addEventListener('DOMContentLoaded',loadCharts);
  </script>
</body>
</html>
